/**
 * @file  uart.c
 *
 * @brief Hardware UART handling for UNIX systems.
 *
 */

#ifndef UART_SERIAL_C_SRC
#define UART_SERIAL_C_SRC

/****************************************************************************
**                                                                         **
**                              MODULES USED                               **
**                                                                         **
****************************************************************************/

#include "uart.h"

/****************************************************************************
**                                                                         **
**                           EXPORTED VARIABLES                            **
**                                                                         **
****************************************************************************/

/****************************************************************************
**                                                                         **
**                           GLOBAL VARIABLES                              **
**                                                                         **
****************************************************************************/

/* Serial port file descriptor */
int uart_fd = -1;

/****************************************************************************
**                                                                         **
**                      PROTOTYPES OF LOCAL FUNCTIONS                      **
**                                                                         **
****************************************************************************/

/****************************************************************************
**                                                                         **
**                           EXPORTED FUNCTIONS                            **
**                                                                         **
****************************************************************************/

uint8_t uart_init( char *device, uint16_t portToutMs )
{
  uint8_t result = 0;

  uart_fd = open( device, O_RDWR | O_NOCTTY );
  if ( uart_fd != -1 )
  {
    struct termios options;
    options.c_cflag       = B115200 | CS8 | CLOCAL | CREAD;
    options.c_iflag       = IGNPAR;
    options.c_oflag       = 0;
    options.c_lflag       = 0;
    options.c_cc[ VMIN ]  = 0;
    options.c_cc[ VTIME ] = portToutMs / 100;
    tcflush( uart_fd, TCIFLUSH );
    tcsetattr( uart_fd, TCSANOW, &options );
    result = 1;
  }
  else
  {
    result = 0;
  }

  return ( result );
}

/***************************************************************************/
/***************************************************************************/
void uart_sendChar( uint8_t byte )
{
  if ( uart_fd != -1 )
    write( uart_fd, &byte, 1 );
}

/***************************************************************************/
/***************************************************************************/
uint8_t uart_recvChar( uint8_t *byte ) {
   return read( uart_fd, byte, 1 );
}

/***************************************************************************/
/***************************************************************************/
void uart_close( void )
{
  if ( uart_fd != -1 )
    close( uart_fd );
}

/****************************************************************************
**                                                                         **
**                             LOCAL FUNCTIONS                             **
**                                                                         **
****************************************************************************/

#endif /* !UART_SERIAL_C_SRC */

/****************************************************************************
**                                                                         **
**                                   EOF                                   **
**                                                                         **
****************************************************************************/